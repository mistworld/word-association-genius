<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>연상천재 - IQ 140 연상퀴즈</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        .screen {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .title {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            color: #00fffc;
        }

        .button {
            background: linear-gradient(135deg, #00fffc, #ff00ff);
            color: black;
            border: none;
            border-radius: 10px;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin: 5px 0;
        }

        .button:active {
            transform: scale(0.95);
        }

        .round-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .round-btn {
            aspect-ratio: 1;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }

        .round-btn.completed {
            background: #00fffc;
            color: black;
        }

        .round-btn.current {
            background: #ff00ff;
            color: black;
        }

        .round-btn.locked {
            background: #666;
            color: #999;
            cursor: not-allowed;
        }

        .problem-info {
            text-align: center;
            margin-bottom: 20px;
            color: #00fffc;
        }

        .hint-box {
            background: rgba(0,255,252,0.1);
            border: 1px solid #00fffc;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .answer-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #00fffc;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .correct-answer {
            text-align: center;
            padding: 20px;
            background: rgba(0,255,252,0.1);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .key-count {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #00fffc, #ff00ff);
            color: black;
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // 게임 상태
        let gameState = {
            currentScreen: 'start',
            currentRound: 1,
            currentProblem: 0,
            keys: 15,
            completedRounds: [],
            problems: [],
            currentProblemState: null
        };

        // 더미 문제 데이터
        const dummyProblems = [
            {
                hints: ["첫 번째 힌트", "두 번째 힌트", "세 번째 힌트", "네 번째 힌트", "다섯 번째 힌트", "여섯 번째 힌트"],
                descriptions: ["첫 번째 설명", "두 번째 설명", "세 번째 설명", "네 번째 설명", "다섯 번째 설명", "여섯 번째 설명"],
                answer: ["정답1"],
                category: "테스트",
                chosung: "ㅈㄷ1",
                characterCount: 3
            },
            {
                hints: ["힌트2-1", "힌트2-2", "힌트2-3", "힌트2-4", "힌트2-5", "힌트2-6"],
                descriptions: ["설명2-1", "설명2-2", "설명2-3", "설명2-4", "설명2-5", "설명2-6"],
                answer: ["정답2"],
                category: "테스트",
                chosung: "ㅈㄷ2",
                characterCount: 3
            }
        ];

        // 저장하기
        function saveGameState() {
            localStorage.setItem('game_save', JSON.stringify(gameState));
        }

        // 불러오기
        function loadGameState() {
            const saved = localStorage.getItem('game_save');
            if (saved) {
                Object.assign(gameState, JSON.parse(saved));
            }
        }

        // 시작 화면
        function showStartScreen() {
            gameState.currentScreen = 'start';
            const html = `
                <div class="container">
                    <div class="screen">
                        <div class="title">⚡연상천재⚡</div>
                        <button class="button" onclick="showRoundMap()">
                            🧠 게임 시작
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('app').innerHTML = html;
        }

        // 라운드 맵
        function showRoundMap() {
            loadGameState();
            gameState.currentScreen = 'roundMap';
            
            const html = `
                <div class="container">
                    <div class="screen">
                        <div class="title">라운드 선택</div>
                        <div class="round-grid">
                            ${[1,2,3,4,5,6].map(round => {
                                const isCompleted = gameState.completedRounds.includes(round);
                                const maxCompleted = gameState.completedRounds.length > 0 ? 
                                    Math.max(...gameState.completedRounds) : 0;
                                const isCurrent = round === maxCompleted + 1;
                                const isLocked = round > maxCompleted + 1 && !isCompleted;
                                
                                return `
                                    <button class="round-btn ${isCompleted ? 'completed' : isCurrent ? 'current' : isLocked ? 'locked' : 'current'}"
                                        onclick="${isLocked ? '' : `startRound(${round})`}"
                                        ${isLocked ? 'disabled' : ''}>
                                        ${round}${isCompleted ? '✅' : isCurrent ? '⭐' : isLocked ? '🔒' : '🎯'}
                                    </button>
                                `;
                            }).join('')}
                        </div>
                        <button class="button" onclick="showStartScreen()">🏠 메인으로</button>
                    </div>
                    <div class="key-count">🔑 ${gameState.keys}</div>
                </div>
            `;
            document.getElementById('app').innerHTML = html;
        }

        // 라운드 시작 - ✅ 1번 문제 해결
        function startRound(roundNumber) {
            gameState.currentScreen = 'game';
            gameState.currentRound = roundNumber;
            
            const savedState = JSON.parse(localStorage.getItem('game_save') || '{}');
            
            // ✅ 1. 이어하기 기능: 저장된 위치부터 시작
            let currentProblem = 0;
            if (savedState.currentRound === roundNumber && savedState.currentProblem !== undefined) {
                currentProblem = savedState.currentProblem;
                // 저장된 문제가 이미 풀렸으면 다음 문제로
                if (savedState.currentProblemState && savedState.currentProblemState.isCorrect) {
                    currentProblem = Math.min(currentProblem + 1, 1); // 2문제만 있으므로 1까지
                }
            }
            
            gameState.currentProblem = currentProblem;
            gameState.problems = [dummyProblems[0], dummyProblems[1]]; // 2문제만
            
            // ✅ 2. 이미 풀린 문제인지 확인
            const isAlreadySolved = savedState.currentProblemState && 
                                  savedState.currentRound === roundNumber && 
                                  savedState.currentProblem === currentProblem && 
                                  savedState.currentProblemState.isCorrect;
            
            gameState.currentProblemState = {
                unlockedHints: isAlreadySolved ? [0,1,2,3,4,5] : [0, 1],
                isCorrect: isAlreadySolved ? true : false,
                userAnswer: ''
            };
            
            renderGameScreen();
            saveGameState();
        }

        // 게임 화면
        function renderGameScreen() {
            const problem = gameState.problems[gameState.currentProblem];
            const state = gameState.currentProblemState;
            
            const html = `
                <div class="container">
                    <div class="screen">
                        <div class="problem-info">
                            라운드 ${gameState.currentRound} - 문제 ${gameState.currentProblem + 1}
                        </div>
                        
                        ${problem.hints.map((hint, index) => `
                            <div class="hint-box">
                                ${state.unlockedHints.includes(index) ? hint : '🔒 잠긴 힌트'}
                            </div>
                        `).join('')}
                        
                        ${!state.isCorrect ? `
                            <input type="text" class="answer-input" placeholder="정답 입력" 
                                value="${state.userAnswer}"
                                oninput="updateUserAnswer(this.value)"
                                onkeydown="if(event.key === 'Enter') checkAnswer(this.value)">
                            <button class="button" onclick="checkAnswer(document.querySelector('.answer-input').value)">
                                정답 제출
                            </button>
                        ` : `
                            <div class="correct-answer">
                                <div>🎯 정답: ${problem.answer[0]}</div>
                                <div>📚 분류: ${problem.category}</div>
                                ${state.isCorrect ? '<div style="color: #ff00ff; margin-top: 10px;">이미 푼 문제입니다</div>' : ''}
                            </div>
                            <button class="button" onclick="nextProblem()">
                                ${gameState.currentProblem === 1 ? '🏆 라운드 완료' : '➜ 다음 문제'}
                            </button>
                        `}
                        
                        <button class="button" onclick="showRoundMap()" style="background: #666; margin-top: 10px;">
                            🗺️ 라운드맵
                        </button>
                    </div>
                    <div class="key-count">🔑 ${gameState.keys}</div>
                </div>
            `;
            document.getElementById('app').innerHTML = html;
        }

        // ✅ 2. 정답 확인 - 이미 푼 문제는 체크 불가
        function checkAnswer(value) {
            const problem = gameState.problems[gameState.currentProblem];
            const state = gameState.currentProblemState;
            
            // 이미 푼 문제면 체크 불가
            if (state.isCorrect) {
                alert('이미 푼 문제입니다!');
                return;
            }
            
            if (value === problem.answer[0]) {
                // 천재보너스: 힌트 2개 이하 사용 시
                if (state.unlockedHints.length <= 2) {
                    gameState.keys += 1;
                    alert('🎉 천재보너스! 열쇠 1개 획득!');
                }
                
                state.isCorrect = true;
                state.unlockedHints = [0,1,2,3,4,5]; // 모든 힌트 오픈
                renderGameScreen();
                saveGameState();
            } else {
                alert('❌ 틀렸습니다! 다시 시도해보세요.');
            }
        }

        // 다음 문제
        function nextProblem() {
            if (gameState.currentProblem < 1) { // 2문제만 있으므로
                gameState.currentProblem++;
                gameState.currentProblemState = {
                    unlockedHints: [0, 1],
                    isCorrect: false,
                    userAnswer: ''
                };
                renderGameScreen();
                saveGameState();
            } else {
                // ✅ 2. 라운드 완료 보상 중복 방지
                if (!gameState.completedRounds.includes(gameState.currentRound)) {
                    gameState.keys += 1;
                    gameState.completedRounds.push(gameState.currentRound);
                    alert('🎊 라운드 완료! 열쇠 1개 획득!');
                }
                showRoundComplete();
                saveGameState();
            }
        }

        function updateUserAnswer(value) {
            gameState.currentProblemState.userAnswer = value;
        }

        function showRoundComplete() {
            const html = `
                <div class="container">
                    <div class="screen">
                        <div class="title">🎉 라운드 ${gameState.currentRound} 완료!</div>
                        <button class="button" onclick="startRound(${gameState.currentRound + 1})">
                            🚀 다음 라운드
                        </button>
                        <button class="button" onclick="showRoundMap()">
                            🗺️ 라운드맵
                        </button>
                    </div>
                    <div class="key-count">🔑 ${gameState.keys}</div>
                </div>
            `;
            document.getElementById('app').innerHTML = html;
        }

        // ✅ 3. 뒤로가기 처리 (간단한 버전)
        window.addEventListener('popstate', function(event) {
            if (gameState.currentScreen === 'game') {
                if (confirm('라운드맵으로 나가시겠습니까?')) {
                    showRoundMap();
                }
            } else if (gameState.currentScreen === 'roundMap') {
                if (confirm('게임을 종료하시겠습니까?')) {
                    // 종료 처리
                }
            }
        });

        // 앱 시작
        loadGameState();
        showStartScreen();
    </script>
</body>
</html>